<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Live Editor</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: white;
            color: black;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark {
            background-color: #333;
            color: white;
        }
        #toolbar {
            display: flex;
            gap: 10px;
            padding: 10px;
            background-color: #eee;
            border-bottom: 1px solid #ccc;
        }
        body.dark #toolbar {
            background-color: #444;
            border-bottom: 1px solid #555;
        }
        #toolbar select, #toolbar button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            color: black;
            cursor: pointer;
        }
        body.dark #toolbar select, body.dark #toolbar button {
            background-color: #555;
            color: white;
            border-color: #666;
        }
        #content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #editor {
            width: 50%;
            display: flex;
            flex-direction: column;
        }
        #input {
            flex: 1;
            resize: none;
            padding: 10px;
            box-sizing: border-box;
            font-family: monospace;
            background-color: inherit;
            color: inherit;
            border: none;
            border-right: 1px solid #ccc;
        }
        body.dark #input {
            border-right: 1px solid #555;
        }
        #error {
            color: red;
            padding: 5px 10px;
            height: 20px;
            overflow: hidden;
        }
        body.dark #error {
            color: #ff9999;
        }
        #output {
            width: 50%;
            overflow: auto;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f8f8f8;
        }
        body.dark #output {
            background-color: #444;
        }
        #output svg {
            transition: transform 0.3s;
            transform-origin: top left;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <select id="mermaid-theme">
            <option value="default">Default</option>
            <option value="dark">Dark</option>
            <option value="forest">Forest</option>
            <option value="neutral">Neutral</option>
        </select>
        <button id="toggle-ui-theme">Toggle Dark Mode</button>
        <button id="download-svg">Download SVG</button>
        <button id="download-png">Download PNG</button>
        <button id="download-jpeg">Download JPEG</button>
        <button id="zoom-in">+</button>
        <button id="zoom-out">-</button>
        <button id="zoom-reset">Reset Zoom</button>
    </div>
    <div id="content">
        <div id="editor">
            <textarea id="input">graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E</textarea>
            <div id="error"></div>
        </div>
        <div id="output"></div>
    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        let config = {
            startOnLoad: false,
            theme: 'default'
        };
        mermaid.initialize(config);

        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const errorDiv = document.getElementById('error');
        const themeSelect = document.getElementById('mermaid-theme');
        const toggleThemeBtn = document.getElementById('toggle-ui-theme');
        const downloadSvgBtn = document.getElementById('download-svg');
        const downloadPngBtn = document.getElementById('download-png');
        const downloadJpegBtn = document.getElementById('download-jpeg');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');

        let lastSvg = '';
        let zoomLevel = 1;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        }

        const renderDiagram = async () => {
            const graphDefinition = input.value.trim();
            if (!graphDefinition) {
                output.innerHTML = '';
                errorDiv.textContent = '';
                return;
            }
            try {
                const { svg } = await mermaid.render('mermaidGraph', graphDefinition);
                lastSvg = svg;
                output.innerHTML = svg;
                updateZoom();
                errorDiv.textContent = '';
            } catch (error) {
                output.innerHTML = '';
                lastSvg = '';
                errorDiv.textContent = error.str || error.message || 'Error rendering diagram';
            }
        };

        const updateZoom = () => {
            const svgElement = output.querySelector('svg');
            if (svgElement) {
                svgElement.style.transform = `scale(${zoomLevel})`;
            }
        };

        const debouncedRender = debounce(renderDiagram, 500);

        input.addEventListener('input', debouncedRender);

        themeSelect.addEventListener('change', () => {
            config.theme = themeSelect.value;
            mermaid.initialize(config);
            renderDiagram();
        });

        toggleThemeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark');
        });

        downloadSvgBtn.addEventListener('click', () => {
            if (!lastSvg) return;
            const blob = new Blob([lastSvg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            a.click();
            URL.revokeObjectURL(url);
        });

        const downloadImage = (type) => {
            if (!lastSvg) return;
            const svgElement = output.querySelector('svg');
            if (!svgElement) return;
            const width = svgElement.viewBox.baseVal.width || svgElement.width.baseVal.value;
            const height = svgElement.viewBox.baseVal.height || svgElement.height.baseVal.value;
            const canvas = document.createElement('canvas');
            canvas.width = width * 2; // Higher res for better quality
            canvas.height = height * 2;
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL(`image/${type}`);
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `diagram.${type}`;
                a.click();
            };
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(lastSvg);
        };

        downloadPngBtn.addEventListener('click', () => downloadImage('png'));
        downloadJpegBtn.addEventListener('click', () => downloadImage('jpeg'));

        zoomInBtn.addEventListener('click', () => {
            zoomLevel += 0.1;
            updateZoom();
        });

        zoomOutBtn.addEventListener('click', () => {
            if (zoomLevel > 0.2) {
                zoomLevel -= 0.1;
                updateZoom();
            }
        });

        zoomResetBtn.addEventListener('click', () => {
            zoomLevel = 1;
            updateZoom();
        });

        // Initial render
        renderDiagram();
    </script>
</body>
</html>
